# BodyScaleCorrection.md
## 体格差補正（トラッカー → お手本再生）仕様

---

## 1. 目的

本補正は、動作提供者（お手本）と動作学習者（評価対象）の体格差を吸収し、
公平な動作比較を行うために導入する。

本システムでは、Tポーズで得られるキャリブレーション情報から体格比率を推定し、
お手本のトラッカーデータ（位置・回転）を学習者体格へ補正して再生する。

---

## 2. 座標系（Unity）

- X：右が正、左が負
- Y：上が正、下が負
- Z：奥が正、手前が負

---

## 3. 記号定義（論文と実装の対応）

| 記号 | 意味 | 実装上の概念 |
|---|---|---|
| H | 頭（Head） | headInput / HeadTracker |
| W | 腰（Waist / Pelvis） | pelvisInput / WaistTracker |
| L | 左手（LeftHand） | leftHandInput / LeftHandTracker |
| R | 右手（RightHand） | rightHandInput / RightHandTracker |
| F | 左足（LeftFoot） | leftFootInput / LeftFootTracker |
| G | 右足（RightFoot） | rightFootInput / RightFootTracker |
| C | 胸（Chest）※腕基準点 | chest基準（推定点） |
| B | 基準原点（腰基準） | initialWaistPosition 等 |

表記ルール：
- 記録者（お手本提供者）のキャリブ値：A
- 記録中の実座標：A'
- 保存した相対量（記録データ）：A˙
- 学習者キャリブ値：Ã（チルダ）
- 学習者体格へ補正した再生位置：Â（ハット）

---

## 4. キャリブレーション（Tポーズ）

Tポーズ時に以下を取得する。

- 頭と腰の高さ差：`(yH - yW)`
- 両手間距離（腕展）：`d = ||R - L||`
- 胸点C（腕基準点）に関する値
  - 腰基準の腕の平均高さ：`ya = (yL + yR)/2 - yW`

---

## 5. 記録データの保存形式

### 5.1 頭・腰・両足
腰基準の相対座標で保存する。

- 位置： `A˙ = A' - W0`（W0は記録開始時の腰位置）
- 回転：トラッカーの回転をそのまま保存

### 5.2 両腕（左手・右手）
腕は腰より腕を起点としているため、
**胸基準の相対量として保存**する。

#### (1) 腕基準高さ（胸点CのY）推定
- 腕平均高さ（腰基準）  
  ya = (yL + yR)/2 - yW

- 記録時胸点（Yのみ）
  yC' = ya * ( (yH' - yW') / (yH - yW) ) + yW'

#### (2) 保存する腕Y（胸基準の変位）
- yR˙ = yR' - yC'
- yL˙ = yL' - yC'

※ X,Z は腰基準の相対として保存してよい（例：xR˙ = xR' - xW'）

---

## 6. 再生時の体格差補正（比率推定）

学習者（チルダ）と記録者（通常）の比率を算出する。

- 腕展距離  
  d  = ||R - L||  
  d~ = ||R~ - L~||

- 頭腰差  
  (yH - yW), (yH~ - yW~)

- 腰高（脚比率）  
  yW, yW~

比率：
- rh = (yH~ - yW~) / (yH - yW)
- ra = d~ / d
- rl = yW~ / yW
- rc = (yC~ - yW~) / (yC - yW)  ※胸‐腰比（Tポーズで推定）

---

## 7. 再生時補正式（最終版：rc導入）

### 7.1 頭・腰・足（腰基準）
学習者の腰位置を基準に補正する。

- H^ = W~ + H˙ * rh
- W^ = W~ + W˙ * rl
- F^ = W~ + F˙ * rl
- G^ = W~ + G˙ * rl

### 7.2 両腕（胸基準 + rc）
胴体（腰→胸）は rc、腕（胸→手）は ra として分離する。

- L^ = W~ + rc(C~ - W~) + ra * L˙
- R^ = W~ + rc(C~ - W~) + ra * R˙

ここで L˙, R˙ は「胸基準で保存した相対量」を意味する。

---

## 8. 本方式のメリット（論文向け）

- Tポーズにより体格情報（頭腰差・腕展・胸腰差）を明示的に推定できる
- お手本データを学習者体格へ補正することで、体格差を原因とする誤差を低減できる
- 補正式が明示的であり、評価の説明可能性が高い（ブラックボックスを避けられる）

---

## 9. 注意点 / 限界

- 本方式は骨格寸法差（身長・腕長・脚長）を主対象とし、
  可動域、筋力、柔軟性といった動作能力差は考慮しない。
- 胸点Cは直接トラッキングできないため推定点であり、
  トラッカー装着位置や姿勢誤差の影響を受ける。

---
