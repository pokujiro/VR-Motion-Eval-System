# SystemOverview.md

（システム全体概要・設計方針）

---

## 1. システム概要

本システムは、VR環境においてユーザの全身動作を取得・再生・評価し、
お手本動作との差分を視覚的・数値的にフィードバックする
**動作学習支援システム**である。

本プロジェクトでは以下を重視して設計を行っている。

* 実機環境での再現性
* 実時間でのフィードバック
* 体格差を考慮した公平な比較
* 卒業研究として説明可能な構造
* 後から機能追加・修正しやすい設計

---

## 2. システム全体構成

システムは以下の責務単位で構成される。

```
SYSTEM
└─ SystemRoot
   ├─ CalibrationService
   ├─ （将来）StateMachine
   ├─ （将来）RecordingService
   ├─ （将来）PlaybackService
   └─ （将来）EvaluationService
```

各コンポーネントは **単一責務** を原則とし、
互いに直接依存しない構造を目指す。

---

## 3. SystemRoot の役割

### 3.1 SystemRoot とは

SystemRoot は、
**システム全体の起点となる管理オブジェクト**である。

主な役割は以下の通り。

* 各 Service の参照元
* 実行状態の集約（将来的に StateMachine を内包）
* Inspector 設定の集中管理

---

### 3.2 設計方針

* Scene 内で SystemRoot は必ず 1 つだけ存在する
* 外部スクリプトが直接 Service を探さない
* 依存関係は「SystemRoot → Service」の一方向とする

---

## 4. CalibrationService の役割

### 4.1 目的

CalibrationService は、
**ユーザの体格情報を取得し、IK（VRIK）に反映する処理**を担当する。

具体的には以下を行う。

* Tポーズ時の入力 Transform 取得
* 身長スケールの算出
* 腕長・脚長の補正係数算出
* 計算結果を VRIK に即時反映

---

### 4.2 なぜ Service として分離するのか

キャリブレーション処理は、

* 入力（トラッカー）
* IK設定
* UI表示
* 状態管理

と複数の要素にまたがる。

これを 1 スクリプトに集約すると、

* 処理の見通しが悪くなる
* 修正時に副作用が起きやすくなる
* 卒論での説明が困難になる

そのため、本システムでは
**Calibration を明確な Service として独立させる設計**を採用している。

---

## 5. 入力・IK・表示の分離

本システムでは、以下の役割分担を厳密に守る。

| 要素                 | 責務                         |
| ------------------ | -------------------------- |
| XR / TRACKERS      | 実デバイスの位置・回転取得              |
| VrikBinder         | 入力 Transform を IK ターゲットに転送 |
| VRIK               | 全身姿勢の計算                    |
| CalibrationService | 体格補正パラメータの算出               |
| UI                 | 操作説明・状態表示                  |

この分離により、

* どこで値が変わるか追いやすい
* デバッグが容易
* 機能追加時の影響範囲が限定される

---

## 6. Inspector 依存を最小化する方針

### 6.1 Inspector 依存とは

Inspector 依存とは、

* 多数のスクリプトで個別に参照設定が必要
* Scene を開くたびに設定確認が必要
* 設定漏れが実行時エラーになる

といった状態を指す。

---

### 6.2 本システムでの対策

* Inspector 設定は SystemRoot に集約
* Service は SystemRoot 経由で参照される
* 実行時に null チェックを行い、即座に検知する

これにより、

* Scene 再利用性が高い
* 設定ミスを初期段階で発見できる
* 他人（将来の自分含む）が理解しやすい

---

## 7. 状態遷移（将来拡張）

現段階では未実装だが、
将来的には以下の状態遷移を想定している。

```
Idle
 ↓
Calibration
 ↓
Ready
 ↓
Recording
 ↓
ImmediateReplay
 ↓
Evaluation
```

StateMachine は SystemRoot の管理下に置き、
Service の実行可否を制御する予定である。

---

## 8. デバッグと再現性

* DebugHUD により現在状態を可視化
* ログに依存しない実機確認を重視
* トラッカー未接続・参照欠落は即座に検知

これにより、
**実験環境特有の不安定さに対して再現性を確保**する。

---

## 9. 本設計の意義（卒論向け）

本システムは、

* 責務分離
* 状態管理
* 実機前提の設計

を明確に意識した構造を採用しており、

「なぜこの構成にしたのか」
「どこを修正すれば拡張できるのか」

を論理的に説明できる点に特徴がある。

---

## 10. まとめ

* SystemRoot を中心とした管理構造
* CalibrationService を独立した責務として定義
* 入力・IK・UI を明確に分離
* 実験・評価・拡張を見据えた設計

本ドキュメントは、
本システム全体の **設計の地図** として位置付けられる。


